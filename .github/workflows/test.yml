
name: test

on: push

jobs:

    test_electron:
        name: Test electron
        # NOTE This test should only run audit_test_electron as other tests don't need multi-OS
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
        runs-on: ${{ matrix.os }}
        steps:

            -   name: Checkout same commit from same repository as this Github Action is from
                uses: actions/checkout@v2

            -   name: Install and cache latest compatible version of node
                uses: actions/setup-node@v1
                with:
                    node-version: '14'

            -   name: Use cache for npm
                # Cached dir is saved after a successful run and copied when used (not mounted)
                uses: actions/cache@v2
                with:
                    path: ~/.npm
                    # Must have new key whenever anything changed (github caches are immutable)
                    # NOTE Caches auto-deleted after 7 days
                    key: ${{ runner.os }}-npm-test-${{ hashFiles('./app/package-lock.json', './displayer/package-lock.json', './electron/package-lock.json') }}
                    # If cache is to change, start with latest one (by prefix) as a base
                    restore-keys: ${{ runner.os }}-npm-test-

            -   name: Install node modules for app
                working-directory: ./app
                run: npm ci

            -   name: Install node modules for displayer
                working-directory: ./displayer
                run: npm ci

            -   name: Install node modules for electron
                working-directory: ./electron
                run: npm ci

            -   name: Build the generic base of the app
                run: |
                    .bin/reactions
                    .bin/build_displayer
                    # .bin/build_responder_aws (done locally and committed due to complexity)
                    .bin/build_app
                env:
                    VITE_OAUTH_SECRET_GOOGLE: ${{ secrets.OAUTH_SECRET_GOOGLE }}
                    VITE_ROLLBAR_APP: ${{ secrets.ROLLBAR_APP }}
                    VITE_ROLLBAR_RESPONDER: ${{ secrets.ROLLBAR_RESPONDER }}
                    VITE_ROLLBAR_DISPLAYER: ${{ secrets.ROLLBAR_DISPLAYER }}
                    REACTIONS_PASSWORD: ${{ secrets.REACTIONS_PASSWORD }}

            -   name: Package with Electron for current OS
                run: |
                    .bin/build_electron
                    mv app/dist electron/src/app
                    .bin/build_electron_package

            -   name: Run tests
                run: .bin/audit_test_electron
